
# Fatos

* De 30 dias para 6 meses houve melhora no modelo
* Usar apenas os daos de interacao buy reduz muito o score no ML
* Embeddings normalizados ajudam a melhorar a curva de loss mas reduzem um pouco a performance. A mascara tambem reduziu um pouco a peformance


# Historico


# SupervisedModelTraining____mars_gym_model_b____6feebc937f



ML: 0.19600

{'count': 1000,
 'mean_average_precision': 0.22327738095238095,
 'model_task': 'SupervisedModelTraining____mars_gym_model_b____6feebc937f',
 'mrr_at_10': 0.22327738095238095,
 'mrr_at_5': 0.22025,
 'ndcg_at_10': 0.25952636823013436,
 'ndcg_at_15': 0.25952636823013436,
 'ndcg_at_20': 0.25952636823013436,
 'ndcg_at_5': 0.2520101183546532,
 'ndcg_at_50': 0.25952636823013436,
 'precision_at_1': 0.188}


# SupervisedModelTraining____mars_gym_model_b____cac288a509

ML: 0.1912

{
    "model_task": "SupervisedModelTraining____mars_gym_model_b____cac288a509",
    "percent_limit": 1.0,
    "count": 1000,
    "mean_average_precision": 0.24455793650793653,
    "precision_at_1": 0.211,
    "mrr_at_5": 0.24168333333333333,
    "mrr_at_10": 0.24455793650793653,
    "ndcg_at_5": 0.27204028852173046,
    "ndcg_at_10": 0.27953293207830093,
    "ndcg_at_15": 0.27953293207830093,
    "ndcg_at_20": 0.27953293207830093,
    "ndcg_at_50": 0.27953293207830093,
    "ndcg_ml": 0.2378027072417554
}

ML: 0.1916

{
    "model_task": "SupervisedModelTraining____mars_gym_model_b____cac288a509",
    "percent_limit": 0.4,
    "count": 1000,
    "mean_average_precision": 0.2445829365079365,
    "precision_at_1": 0.212,
    "mrr_at_5": 0.24168333333333333,
    "mrr_at_10": 0.2445829365079365,
    "ndcg_at_5": 0.27104028852173045,
    "ndcg_at_10": 0.2785652354159703,
    "ndcg_at_15": 0.2785652354159703,
    "ndcg_at_20": 0.2785652354159703,
    "ndcg_at_50": 0.2785652354159703,
    "ndcg_ml": 0.23825061255771743
}

# SupervisedModelTraining____mars_gym_model_b____3fcfe47a17

"sample_view": 10000 

ML: 0.1866

{'count': 1000,
 'mean_average_precision': 0.2394373015873016,
 'model_task': 'SupervisedModelTraining____mars_gym_model_b____3fcfe47a17',
 'mrr_at_10': 0.2394373015873016,
 'mrr_at_5': 0.23443333333333333,
 'ndcg_at_10': 0.2859531007691741,
 'ndcg_at_15': 0.2859531007691741,
 'ndcg_at_20': 0.2859531007691741,
 'ndcg_at_5': 0.2734792498335262,
 'ndcg_at_50': 0.2859531007691741,
 'ndcg_ml': 0.24913278525801766,
 'percent_limit': 1.0,
 'precision_at_1': 0.195}


# MercadoLivreTraining____mars_gym_model_b____7f1da3af0f

"sample_view": 10000 and class_weigth

ML: 0.13510

{'count': 1000,
 'mean_average_precision': 0.13661785714285712,
 'model_task': 'MercadoLivreTraining____mars_gym_model_b____7f1da3af0f',
 'mrr_at_10': 0.13661785714285712,
 'mrr_at_5': 0.13558333333333333,
 'ndcg_at_10': 0.1456271790359318,
 'ndcg_at_15': 0.1456271790359318,
 'ndcg_at_20': 0.1456271790359318,
 'ndcg_at_5': 0.14291650827500021,
 'ndcg_at_50': 0.1456271790359318,
 'ndcg_ml': 0.1233714427025859,
 'percent_limit': 1.0,
 'precision_at_1': 0.128}

 # SupervisedModelTraining____mars_gym_model_b____00c94553b8

Embs: 57880,   "sample_view": 30000

 ML: 0.179495

 {'count': 1000,
 'mean_average_precision': 0.24366904761904762,
 'model_task': 'SupervisedModelTraining____mars_gym_model_b____00c94553b8',
 'mrr_at_10': 0.24366904761904762,
 'mrr_at_5': 0.24013333333333337,
 'ndcg_at_10': 0.29936018769932865,
 'ndcg_at_15': 0.29936018769932865,
 'ndcg_at_20': 0.29936018769932865,
 'ndcg_at_5': 0.2903277006440901,
 'ndcg_at_50': 0.29936018769932865,
 'ndcg_ml': 0.25930900881019453,
 'percent_limit': 1.0,
 'precision_at_1': 0.189}


# SupervisedModelTraining____mars_gym_model_b____06e74a0146

 ML? 0.20194	

 {'count': 1000,
 'mean_average_precision': 0.2677611111111111,
 'model_task': 'SupervisedModelTraining____mars_gym_model_b____06e74a0146',
 'mrr_at_10': 0.2677611111111111,
 'mrr_at_5': 0.26526666666666665,
 'ndcg_at_10': 0.30712078947113514,
 'ndcg_at_15': 0.30712078947113514,
 'ndcg_at_20': 0.30712078947113514,
 'ndcg_at_5': 0.3006351645788738,
 'ndcg_at_50': 0.30712078947113514,
 'ndcg_ml': 0.2636584813154937,
 'percent_limit': 1.0,
 'precision_at_1': 0.229}


# SupervisedModelTraining____mars_gym_model_b____d9c9625fad

 ML:  0.20554

 {
    "model_task": "SupervisedModelTraining____mars_gym_model_b____d9c9625fad",
    "percent_limit": 1.0,
    "count": 1000,
    "mean_average_precision": 0.29698928571428573,
    "precision_at_1": 0.247,
    "mrr_at_5": 0.29375,
    "mrr_at_10": 0.29698928571428573,
    "ndcg_at_5": 0.3397346581878777,
    "ndcg_at_10": 0.3480408450537393,
    "ndcg_at_15": 0.3480408450537393,
    "ndcg_at_20": 0.3480408450537393,
    "ndcg_at_50": 0.3480408450537393,
    "ndcg_ml": 0.2915108439658228
}

# Ensamble - final_submission_dowdall - 6ce3c531e5 - b4197a226b - 1da67a8f8e - c179ab54fa

Ensamble 
ML: 0.21576


# Ensamble - final_submission_borda - 6ce3c531e5 - b4197a226b - 1da67a8f8e - c179ab54fa

Ensamble com pos processamento de 0.4

ML: 0.22528

## Submission

#### Train 5 k_fold models + 1 completo (lembrar de adicionar o máximo de dados que puder, tirar o 
#### local_test no caso, ao menos no completo )

mars-gym run supervised \
--project mercado_livre.config.mercado_livre_narm \
--recommender-module-class model.MLNARMModel2 \
--recommender-extra-params '{
  "n_factors": 100, 
  "hidden_size": 200, 
  "dense_size": 19,
  "n_layers": 1, 
  "dropout": 0.2, 
  "history_window": 20, 
  "history_word_window": 3,
  "from_index_mapping": false,
  "path_item_embedding": "/media/workspace/triplet_session/output/mercado_livre/assets/mercadolivre-100d.bin", 
  "freeze_embedding": true}' \
--data-frames-preparation-extra-params '{
  "sample_days": 60, 
  "history_window": 20, 
  "column_stratification": "SessionID",
  "normalize_dense_features": "min_max",
  "min_interactions": 5,
  "filter_only_buy": true,
  "sample_view": 10000}' \
--optimizer adam \
--optimizer-params '{"weight_decay": 1e-4}' \
--test-size 0.0 \
--val-size 0.1 \
--early-stopping-min-delta 0.0001 \
--test-split-type random \
--dataset-split-method column \
--learning-rate 0.001 \
--metrics='["loss"]' \
--generator-workers 5  \
--batch-size 512 \
--loss-function ce \
--epochs 1000 \
--obs "1"


mars-gym run supervised \
--project mercado_livre.config.mercado_livre_narm \
--recommender-module-class model.MLNARMModel2 \
--recommender-extra-params '{
  "n_factors": 100, 
  "hidden_size": 200, 
  "dense_size": 19,
  "n_layers": 1, 
  "dropout": 0.2, 
  "history_window": 20, 
  "history_word_window": 3,
  "from_index_mapping": false,
  "path_item_embedding": "/media/workspace/triplet_session/output/mercado_livre/assets/mercadolivre-100d.bin", 
  "freeze_embedding": true}' \
--data-frames-preparation-extra-params '{
  "sample_days": 60, 
  "history_window": 20, 
  "column_stratification": "SessionID",
  "normalize_dense_features": "min_max",
  "min_interactions": 5,
  "filter_only_buy": true,
  "sample_view": 10000}' \
--optimizer adam \
--optimizer-params '{"weight_decay": 1e-4}' \
--test-size 0.0 \
--val-size 0.1 \
--early-stopping-min-delta 0.0001 \
--test-split-type random \
--dataset-split-method k_fold \
--n-splits 5 \
--split-index 0 \
--learning-rate 0.001 \
--metrics='["loss"]' \
--generator-workers 5  \
--batch-size 512 \
--loss-function ce \
--epochs 100 \
--obs "kfold@1"



mars-gym run supervised \
--project mercado_livre.config.mercado_livre_narm \
--recommender-module-class model.MLNARMModel2 \
--recommender-extra-params '{
  "n_factors": 100, 
  "hidden_size": 200, 
  "dense_size": 19,
  "n_layers": 1, 
  "dropout": 0.2, 
  "history_window": 20, 
  "history_word_window": 3,
  "from_index_mapping": false,
  "path_item_embedding": "/media/workspace/triplet_session/output/mercado_livre/assets/mercadolivre-100d.bin", 
  "freeze_embedding": true}' \
--data-frames-preparation-extra-params '{
  "sample_days": 60, 
  "history_window": 20, 
  "column_stratification": "SessionID",
  "normalize_dense_features": "min_max",
  "min_interactions": 5,
  "filter_only_buy": true,
  "sample_view": 10000}' \
--optimizer adam \
--optimizer-params '{"weight_decay": 1e-4}' \
--test-size 0.0 \
--val-size 0.1 \
--early-stopping-min-delta 0.0001 \
--test-split-type random \
--dataset-split-method k_fold \
--n-splits 5 \
--split-index 1 \
--learning-rate 0.001 \
--metrics='["loss"]' \
--generator-workers 5  \
--batch-size 512 \
--loss-function ce \
--epochs 100 \
--obs "kfold@2"

### Generate submission with 100 registros cada, dá 6 arquivos.
### é bom testar local

SupervisedModelTraining____mars_gym_model_b____c179ab54fa
SupervisedModelTraining____mars_gym_model_b____1da67a8f8e
SupervisedModelTraining____mars_gym_model_b____b4197a226b
SupervisedModelTraining____mars_gym_model_b____6ce3c531e5

PYTHONPATH="." luigi --module mercado_livre.evaluation EvaluationSubmission \
--model-task-class "mars_gym.simulation.training.SupervisedModelTraining" \
--model-task-id SupervisedModelTraining____mars_gym_model_b____c179ab54fa \
--normalize-file-path "7cef5bca66_std_scaler.pkl" \
--history-window 20 \
--batch-size 1000 \
--percent-limit 1 \
--local-scheduler \
--submission-size 100 \
--model-eval "model" \
--local


PYTHONPATH="." luigi --module mercado_livre.evaluation EvaluationSubmission \
--model-task-class "mars_gym.simulation.training.SupervisedModelTraining" \
--model-task-id SupervisedModelTraining____mars_gym_model_b____1da67a8f8e \
--normalize-file-path "960f0cb112_std_scaler.pkl" \
--history-window 20 \
--batch-size 1000 \
--percent-limit 1 \
--local-scheduler \
--submission-size 100 \
--model-eval "model" \
--local  


PYTHONPATH="." luigi --module mercado_livre.evaluation EvaluationSubmission \
--model-task-class "mars_gym.simulation.training.SupervisedModelTraining" \
--model-task-id SupervisedModelTraining____mars_gym_model_b____b4197a226b \
--normalize-file-path "768d27bebe_std_scaler.pkl" \
--history-window 20 \
--batch-size 1000 \
--percent-limit 1 \
--local-scheduler \
--submission-size 100 \
--model-eval "model" \
--local  


PYTHONPATH="." luigi --module mercado_livre.evaluation EvaluationSubmission \
--model-task-class "mars_gym.simulation.training.SupervisedModelTraining" \
--model-task-id SupervisedModelTraining____mars_gym_model_b____6ce3c531e5 \
--normalize-file-path "5623558488_std_scaler.pkl" \
--history-window 20 \
--batch-size 1000 \
--percent-limit 1 \
--local-scheduler \
--submission-size 100 \
--model-eval "model" \
--local  

##

PYTHONPATH="." luigi --module mercado_livre.evaluation EvaluationSubmission \
--model-task-class "mars_gym.simulation.training.SupervisedModelTraining" \
--model-task-id SupervisedModelTraining____mars_gym_model_b____6ce3c531e5 \
--normalize-file-path "7cef5bca66_std_scaler.pkl" \
--history-window 20 \
--batch-size 1000 \
--percent-limit 1 \
--local-scheduler \
--submission-size 100 \
--model-eval "model" \
--eval-reclist mercado_livre/data/final_submission_dowdall.csv \
--local



### Unificar o ensamble com notebook "Rank Ensamble", gera 4 arquivos devido as estratégias
### instant_runoff, borda, dowdall, average_rank

"Rank Ensamble".yml


### Otimiza o arquivo final com a normalização do dominio, limitando em 10 recomendações. Usa o notebook 